在之后对库存功能熟悉以后，再对库存功能进行一个重写。



熟悉电商的都知道，库存的扣减有多个节点，比较典型的就是以下2个：



1. 下单扣减节点
2. 支付扣减节点



## 方案选择
### 下单扣减库存
即在用户创建订单的时候就直接扣减库存。

![[395349ec-8bc5-43c1-8c9e-cdf338b15309.svg]]

这种方案的好处是：

1、**实时性强：** 库存在用户下单时即被扣减，确保了库存的及时更新。

**2、简单直接：** 操作流程相对简单，易于实现和管理。

**3、避免超卖：** 可以有效避免因多人同时下单而导致的超卖问题。



但是缺点也比较明显：

**1、取消订单问题：** 如果用户取消订单或者超时未支付，需要额外处理库存回滚的逻辑。

**2、支付失败影响：** 如果用户不支付，或者支付失败，可能需要额外处理库存的恢复。甚至会导致少卖。

**3、并发量高：**下单的并发量很大，在这个环节做库存的扣减会存在显著的热点问题

### 支付扣减库存
即在用户创建订单的时候不扣减库存，而在用户支付成功后再扣减库存

![[c721c021-d740-4dbe-94c4-357e908d91fd.svg]]

这种方案的好处是：

**避免少卖与订单浪费：** 确保了库存的准确性，只有在用户支付成功后才会真正扣减库存。

**避免取消订单问题：** 用户取消订单或者超时未支付时，无需额外处理库存的回滚。

**并发量没那么高**：支付成功的并发其实没有下单高，并且是可以有异步重试的。

缺点也同样明显：

**超卖风险：** 如果多人同时下单，支付成功后库存可能不足，或者扣减失败，不仅影响用户体验，还可能会超卖



## 我们的方案
✅我们选择的是下单扣库存的方案，为了避免超卖，因为我们是数字藏品类业务，出现恶意占用库存的情况比较少，并且因为不是实物，没有备货压力，所以影响不太大。

//TODO 三种秒杀扣库存方案

![[39f2b0aa-67ab-4189-9907-cbce680eb7bf.svg]]

## 模型设计
在藏品的库存模型的设计上，我们通过3个字段来表示和库存有关的信息（occupiedInventory后被废弃），分别是：

```plain
/** * '藏品数量' */private Long quantity;
/** * '可售库存' */private Long saleableInventory;
/** * '已占库存' * @deprecated 这个字段不再使用，详见 CollecitonSerivce.confirmSale*/@Deprecatedprivate Long occupiedInventory;



Plain Text
```

藏品数量表示这个藏品的总可售数量，这个数据从创建之后开始就不再变化了，表示这个藏品最多可以被卖多少份。

可售库存表示当前可以被用户下单购买的剩余库存量，这个字段的值随着用户的每次下单行为会开始进行递减。

~~已占库存表示当前用户下单后，并且完成支付的库存的总量，这个字段会随着用户的每次支付行为开始进行递增。~~

**库存恒等式**：

1、quantity >=0 

2、saleableInventory>=0

~~3、occupiedInventory >= 0 && occupiedInventory <= quantity~~

~~4、saleableInventory + occupiedInventory <= quantity~~

## 库存缓存设计
为了提升秒杀的性能，我们会把库存在 Redis 中存一份，并且在每次用户下单的时候先从 Redis 中进行扣减。

详细过程及设计参考：

//TODO



## 流程设计
库存的整体扣减我们分成了2个阶段，用了一种 `try-confirm-cancel` 的形式：



一阶段Try，下单环节

![[f187a0b2-a2be-4225-96af-d23331f54b18.svg]]



这个环节主要是做预扣减，分别先在 redis 中做预扣减，如果能扣减成功，我们会发一个异步事件，到数据库中也做一次预扣减，这里可以利用事件做一些削峰填谷，做一点流量的缓冲。（在这个期间，前端不断轮询是否有订单创建成功的，成功则跳转支付页，一定时间还是没查到则提示创单失败）



如果出现了Redis 扣减成功，但是消息丢了或者延迟了的情况，我们会通过 Redis中的扣减流水来做核对，发现过了1分钟还是没能在数据库扣减成功，则就需要人工的把这个库存在 Redis 中补偿回去。



二阶段 Cancel，订单超时&用户取消



![[04aa0480-2036-4fe8-85ee-b6344c6bc919.png]]



## 数据库设计
### 类图
![[a4ee50c9-7732-4e95-ae54-cc31d815d143.jpeg]]

