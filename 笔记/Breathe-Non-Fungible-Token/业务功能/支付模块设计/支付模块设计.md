- [x] 支付模块设计  [completion:: 2025-08-17]

支付模块, 承担了我们项目中和支付相关的功能, 是我们项目中非常重要的模块.

![[Pasted image 20250817000502.png]]

## 模型设计

![[Pasted image 20250817000514.png]]

为了这张支付单有更高的通用性, 我们在这个支付单这张表中没有任何的订单有关的信息, 我们的付款方没有叫buyer_id, 存订单号也没有用order_id, 而是定义了支付单domain自己的属性, 如付款方, 收款方, 业务单号等. 目的就是更具有通用性, 模型更加内聚.

同时为了支持多付退款, 我们有一张退款单的表.


## 状态机

![[Pasted image 20250817000709.png]]

## 业务流程

### 下单支付

![[Pasted image 20250817000827.png]]

### 多付退款

在支付环节，是有一种特殊情况，那就是多付的情况，就是一笔订单，重复支付了。

![[Pasted image 20250817001309.png]]

在支付成功的处理中，我们会检查订单的状态，如果支付单对应的订单未支付成功，说明当前是第一次支付成功，则执行上面的支付成功逻辑即可。

如果支付单对应的订单已经支付成功了，那么就有2种可能：

1、同一个支付成功回调，支付渠道消息重投了。

2、不同的支付成功回调，用户多付了。

如果是第一种情况，那么直接幂等掉，返回成功即可，

如果是第二种情况，那么则需要进行退款了。

具体的关于为什么会重复支付、如何解决，详见：

[[重复支付问题如何解决]]