在数字藏品领域，盲盒功能是一种基于随机性和惊喜感的购买体验，通常用于吸引用户参与并增加数字藏品的收藏乐趣。这一功能借鉴了传统实体盲盒的概念，在数字藏品的购买和交易中引入了随机性和稀有性元素。



数字藏品中的盲盒和普通藏品的主要区别就是随机性。用户在购买盲盒时，无法预先知道自己将获得哪种具体的数字藏品。每个盲盒内含有多个可能的数字藏品，每一件藏品的稀有度、价值或属性都可能不同。这种不确定性为用户带来了挑战和乐趣。



在我们的项目中，盲盒的功能在 nft-turbo-box 这个 module 下：



![[7fbccc27-e50d-4f57-82de-23984c149928.png]]

## 系统设计


![[f6845f3b-6e96-450d-ab52-993c7a5b0e70.jpeg]]



## ER图
![[86964394-7cd4-4345-bd7b-b913c32431b5.jpeg]]



和藏品有关的表主要是 blind_box、blind_box_item 以及 blind_box_inventory_stream表，以及和他们有关的还有 held_collection 表、trade_order 表。

<font style="color:rgb(38, 38, 38);"></font>

+ <font style="color:rgb(38, 38, 38);">blind_box</font>
    - <font style="color:rgb(38, 38, 38);">盲盒表，主要记录了盲盒的数量、价格、标题、封面、状态等信息。</font>
+ <font style="color:rgb(38, 38, 38);">blind_box_item</font>
    - <font style="color:rgb(38, 38, 38);">盲盒条目表，和盲盒表是多对一的关系，一个盲盒中有多个条目。比如说创建一个盲盒，其中有一百个藏品，那么就会对应有100个盲盒条目，每个条目上还有自己的藏品的标题、封面、订单号、用户之类的信息。</font>
+ <font style="color:rgb(38, 38, 38);">blind_box_inventory_stream</font>
    - <font style="color:rgb(38, 38, 38);">盲盒库存流水，记录盲盒的每一次购买行为的。</font>

<font style="color:rgb(38, 38, 38);"></font>

<font style="color:rgb(38, 38, 38);">后台用户，在创建一个盲盒时候，就会同时把他所有的条目一起创建好，这时候的条目处理用户信息、订单信息之外，其他的信息就都已经有了。</font>

<font style="color:rgb(38, 38, 38);"></font>

<font style="color:rgb(38, 38, 38);">然后用户在购买盲盒的时候（准确的说是支付成功的时候），对于盲盒藏品来说，就会随机挑选出一个盲盒条目来进行绑定，这时候就已经确定了他后面开盒的时候能开出来什么东西。后面在开盒的时候，只是一个带有用户信息的盲盒条目转成藏品的过程。</font>

<font style="color:rgb(38, 38, 38);"></font>

<font style="color:rgb(38, 38, 38);">所以模型的流转过程是：</font>

<font style="color:rgb(38, 38, 38);"></font>

![[31de1be2-7517-46db-939d-68f88b6a1f49.jpeg]]



## 系统交互
### 盲盒创建过程
![[03cfb03c-9e3e-497e-a774-a1c741fd4202.svg]]

### 用户下单过程
![[5589ab39-15ee-4acb-a4fc-2da54a97fe09.svg]]

用户下单流程，对于盲盒来说没有什么特殊的，和藏品一样，做一次库存的预扣减即可。具体的扣减方案也和藏品一直，不展开说了，详细的在交易模块中体现。

### 用户支付成功
![[6e070891-a776-44d5-b4fa-c964344f633f.svg]]

### 用户打开盲盒
![[67a31dd5-213b-4ab0-ba5f-deea55f72017.svg]]

### 状态图
### 盲盒状态机
![[8d941a1b-7099-4c9e-89d9-7c157b3fff78.jpeg]]

+ <font style="color:rgb(38, 38, 38);">INIT</font>
    - <font style="color:rgb(38, 38, 38);">盲盒创建成功之后，状态位 INIT</font>
+ <font style="color:rgb(38, 38, 38);">SUCCEED</font>
    - <font style="color:rgb(38, 38, 38);">盲盒上链成功后，状态为 SUCCEED</font>
+ <font style="color:rgb(38, 38, 38);">REMOVED</font>
    - <font style="color:rgb(38, 38, 38);">盲盒被销毁后，状态为 REMOVED</font>

### <font style="color:rgb(38, 38, 38);">盲盒条目状态图</font>
![[0cc78e41-ac95-4fc2-8184-47060f99d1aa.jpeg]]

+ <font style="color:rgb(38, 38, 38);">INIT</font>
    - <font style="color:rgb(38, 38, 38);">盲盒条目创建成功之后，状态为 INIT，这时候还没分配给任何一个用户</font>
+ <font style="color:rgb(38, 38, 38);">ASSIGNED</font>
    - <font style="color:rgb(38, 38, 38);">用户支付成功后，带上订单、用户等信息后，状态推进到 ASSIGNED</font>
+ <font style="color:rgb(38, 38, 38);">OPENING</font>
    - <font style="color:rgb(38, 38, 38);">用户在针对某个盲盒（条目）做打开盲盒动作的时候，先推进到 OPENING</font>
+ <font style="color:rgb(38, 38, 38);">SUCCESS</font>
    - <font style="color:rgb(38, 38, 38);">直到held_collection 创建成功、上链调用成功后，推进到 SUCCESS</font>

