## 一、系统设计
![[132dbd41-47e4-4edd-908f-3eabb1fa7cf1.jpeg]]

### 时序图
![[906078fb-7f9b-4314-ac41-6d9113687d78.svg]]

### ER图
![[9f688c7f-eb6d-41a7-b4b4-27bddab44593.png]]



和藏品有关的表主要是 collection、collection_snapshot、held_collection 以及 collection_stream、collection_inventory_stream 表。



+ <font style="color:rgb(38, 38, 38);">collection</font>
    - <font style="color:rgb(38, 38, 38);">藏品表，主要是保存一个藏品的主要信息，以及库存、价格等信息。可以进行售卖。</font>
+ <font style="color:rgb(38, 38, 38);">held_collection</font>
    - <font style="color:rgb(38, 38, 38);">持有藏品表，当一个藏品被购买之后，会转换成持有藏品，其中包含了持有者信息、藏品序列号等。可以进行售卖、也可以进行合成、转赠等其他操作</font>
+ <font style="color:rgb(38, 38, 38);">collection_stream</font>
    - <font style="color:rgb(38, 38, 38);">藏品流水表，主要是记录产品的变更记录。</font>
+ <font style="color:rgb(38, 38, 38);">collection_snapshot</font>
    - <font style="color:rgb(38, 38, 38);">藏品快照表，每一个藏品的核心信息的修改，如价格修改，图片修改等，都会生成一个新的版本，并记录一个快照，用于订单记录快照版本号，方便回溯当时下单时的藏品相关信息。</font>
+ <font style="color:rgb(38, 38, 38);">collection_inventory_stream</font>
    - <font style="color:rgb(38, 38, 38);">藏品库存流水表，记录每一次藏品的库存变更有关的流水，主要用于幂等控制以及数据对账。</font>



### 状态图
![[f485d8dc-41b1-4bd7-9308-dfe938c50c4e.jpeg]]



+ <font style="color:rgb(38, 38, 38);">  
</font><font style="color:rgb(38, 38, 38);">INIT</font>
    - <font style="color:rgb(38, 38, 38);">藏品创建成功之后，状态位 INIT</font>
+ <font style="color:rgb(38, 38, 38);">SUCCEED</font>
    - <font style="color:rgb(38, 38, 38);">藏品上链成功后，状态为 SUCCEED</font>
+ <font style="color:rgb(38, 38, 38);">REMOVED</font>
    - <font style="color:rgb(38, 38, 38);">藏品被销毁后，状态为 REMOVED</font>

## <font style="color:rgb(38, 38, 38);">二、接口设计</font>
### 获取藏品列表
//TODO

### 获取藏品信息
//TODO

### 上链藏品
//TODO

### 藏品出售的try阶段，做库存的预占用
//TODO

### 藏品出售的confirm阶段，做真正售出
//TODO

### 藏品出售的cancel阶段，做库存退还（在confirm或try失败后调用）
//TODO

其实上面三个就是一个完整的TCC流程

### 转移藏品
//TODO

### 销毁藏品
//TODO



藏品模块主要是用来做藏品的管理，主要包含了藏品的创建、交易、上链等动作。1.获取藏品列表  
路径：/collection/collectionList  
方法：GET  
请求参数：  
{  
    "state": "SUCCEED",  
    "pageSize": 10,  
    "currentPage": 1  
}  
响应：  
{  
  "status": true,  
  "data": {  
    "current": 1,  
    "count": 100,  
    "size": 10,  
    "record": [  
      {  
        "id": "",  
        "name": "",  
        "cover": "",  
        "classId": ""  
      }  
    ]  
  }  
}

2.获取藏品详情  
路径：/collection/collectionInfo  
方法：GET  
请求参数：  
{  
    "collectionId": "1"  
}  
响应：

3.上链藏品  
CollectionChainResponse chain(CollectionChainRequest request);  
public class CollectionChainRequest extends BaseCollectionRequest {  
    /**  
     * 幂等号  
     */  
    private String identifier;

```plain
/**
 * '藏品名称'
 */
private String name;

/**
 * '藏品封面'
 */
private String cover;

/**
 * '藏品类目id'
 */
private String classId;

/**
 * '价格'
 */
private BigDecimal price;

/**
 * '藏品数量'
 */
private Long quantity;

/**
 * '藏品创建时间'
 */
private Date createTime;

/**
 * '藏品发售时间'
 */
private Date saleTime;

/**
 * '藏品创建者id'
 */
private String creatorId;

@Override
public CollectionEvent getEventType() {
    return CollectionEvent.CHAIN;
}
```

}

public class CollectionChainResponse extends BaseResponse {  
    /**  
     * 藏品id  
     */  
    private Long collectionId;

}  
4.藏品出售的try阶段，做库存预占用  
    CollectionSaleResponse trySale(CollectionSaleRequest request);  
public class CollectionSaleRequest extends BaseCollectionRequest {  
    /**  
     * 幂等号  
     */  
    private String identifier;

```plain
/**
 * '藏品id'
 */
private Long collectionId;

/**
 * '持有人id'
 */
private String userId;

/**
 * 销售数量
 */
private Long quantity;


@Override
public CollectionEvent getEventType() {
    return CollectionEvent.SALE;
}
```

}  
public class CollectionSaleResponse extends BaseResponse {  
    /**  
     * 持有藏品id  
     */  
    private Long heldCollectionId;

}

5.藏品出售的confirm阶段，做真正售出  
CollectionSaleResponse confirmSale(CollectionSaleRequest request);  
public class CollectionSaleRequest extends BaseCollectionRequest {  
    /**  
     * 幂等号  
     */  
    private String identifier;

```plain
/**
 * '藏品id'
 */
private Long collectionId;

/**
 * '持有人id'
 */
private String userId;

/**
 * 销售数量
 */
private Long quantity;


@Override
public CollectionEvent getEventType() {
    return CollectionEvent.SALE;
}
```

}  
public class CollectionSaleResponse extends BaseResponse {  
    /**  
     * 持有藏品id  
     */  
    private Long heldCollectionId;

}

6.藏品出售的cancel阶段，做库存退还  
CollectionSaleResponse cancelSale(CollectionSaleRequest request);  
public class CollectionSaleRequest extends BaseCollectionRequest {  
    /**  
     * 幂等号  
     */  
    private String identifier;

```plain
/**
 * '藏品id'
 */
private Long collectionId;

/**
 * '持有人id'
 */
private String userId;

/**
 * 销售数量
 */
private Long quantity;


@Override
public CollectionEvent getEventType() {
    return CollectionEvent.SALE;
}
```

}  
public class CollectionSaleResponse extends BaseResponse {  
    /**  
     * 持有藏品id  
     */  
    private Long heldCollectionId;

}

7.转移藏品  
CollectionTransferResponse transfer(CollectionTransferRequest request);  
public class CollectionTransferRequest extends BaseCollectionRequest {  
    /**  
     * 幂等号  
     */  
    private String identifier;

```plain
/**
 * '藏品id'
 */
private Long collectionId;

/**
 * '持有藏品id'
 */
private Long heldCollectionId;

/**
 * '买家id'
 */
private Long buyerId;

/**
 * '卖家id'
 */
private Long sellerId;


@Override
public CollectionEvent getEventType() {
    return CollectionEvent.TRANSFER;
}
```

}  
public class CollectionTransferResponse extends BaseResponse {  
    /**  
     * 持有藏品id  
     */  
    private Long heldCollectionId;

}  
8.销毁藏品  
CollectionDestroyResponse destroy(CollectionDestroyRequest request);  
public class CollectionDestroyRequest extends BaseCollectionRequest {  
    /**  
     * 幂等号  
     */  
    private String identifier;

```plain
/**
 * '藏品id'
 */
private Long collectionId;

/**
 * '持有藏品id'
 */
private Long heldCollectionId;


@Override
public CollectionEvent getEventType() {
    return CollectionEvent.DESTORY;
}
```

}  
public class CollectionDestroyResponse extends BaseResponse {  
    /**  
     * 持有藏品id  
     */  
    private Long heldCollectionId;

}  
9.预扣减库存  
public SingleResponse preInventoryDeduct(Long collectionId, int quantity, String identifier); Long collectionId, int quantity, String identifier Boolean

