藏品转让，指的是用户把自己购买过的藏品转让给其他用户，转让藏品的归属权。就和大家在大麦上转让你的演唱会门票是一样的。



一次藏品转让的目标是：修改这个藏品所归属的用户，那么就有以下2种做法

+ 1、直接在原来的持有藏品上面修改 (简单-----缺少过程数据，没办法看历史数据，没办法做数据分析和统计）
+ **2、把老的持有藏品状态设置为已失效（INACTIVE），同时创建新的持有藏品，并且上链，状态推进到 ACTIVE （复杂但是有所有过程数据）**

所以为了避免数据丢失，我们选择的是第二个方案。完整流程如下：



![[33a28551-a3fb-4849-990c-5581a22b0627.svg]]



在新的藏品生成的过程中，新的持有藏品和老的持有藏品，只有以下5个字段是新的，其他的都和老藏品一样带过来即可：

```java
this.userId = recipientUserId; //归属用户
this.holdTime = new Date();    //用户持有时间
this.bizType = GoodsSaleBizType.TRANSFER;   //藏品获得类型
this.state = HeldCollectionState.INIT;   //状态
this.preId = heldCollection.getUserId();  //上一个归属的人的 ID
```

这里状态不能直接设置为 ACTIVE，因为我们还需要做链上操作，藏品在链上完成转发之后再推进到 ACITIVE。



完成转让之后（上链之前），转出的持有藏品和转入的持有藏品的信息如下：



| **字段名** | **转出的藏品** | **转入的藏品** |
| --- | --- | --- |
| id | 1886333860223307776 | 1898623237804707843 |
| gmt_create | 2025-02-03 16:40:13 | 2025-03-16 13:52:40 |
| gmt_modified | 2025-03-16 13:45:15 | 2025-03-16 13:52:40 |
| collection_id | 10080 | 10080 |
| name | 21 | 21 |
| cover | https://nfturbo-file.oss-cn-hangzhou.aliyuncs.com/collection/36/image (1).png | https://nfturbo-file.oss-cn-hangzhou.aliyuncs.com/collection/36/image (1).png |
| purchase_price | 212.000000 | 212.000000 |
| serial_no | 7 | 7 |
| nft_id | nftId | nftId |
| pre_id | <font style="color:rgb(153, 153, 153);">NULL</font> | 29 |
| user_id | 29 | 8 |
| state | <font style="color:rgb(230, 36, 18);">INACTIVED</font> | INIT |
| tx_hash | b11dfd1b-3b43-4a28-98b2-75b097fe6948 | <font style="color:rgb(153, 153, 153);">NULL</font> |
| hold_time | 2025-02-03 16:40:13 | 2025-03-16 13:52:31 |
| sync_chain_time | 2025-02-03 16:40:19 | <font style="color:rgb(153, 153, 153);">NULL</font> |
| delete_time | <font style="color:rgb(153, 153, 153);">NULL</font> | <font style="color:rgb(153, 153, 153);">NULL</font> |
| deleted | 0 | 0 |
| lock_version | 2 | 0 |
| biz_no | 1018863338363619655680003 | 1886333860223307776 |
| biz_type | PRIMARY_TRADE | TRANSFER |
| reference_price | 212.000000 | 212.000000 |
| rarity | <font style="color:rgb(153, 153, 153);">NULL</font> | <font style="color:rgb(153, 153, 153);">NULL</font> |


在完成上链之后，数据发生如下变化：

| | | |
| --- | --- | --- |
| | **上链成功前** | **上链成功后** |
| id | 1898623237804707843 | 1898623237804707843 |
| gmt_create | 2025-03-16 13:52:40 | 2025-03-16 13:52:40 |
| gmt_modified | 2025-03-16 13:52:40 | 2025-03-16 13:59:02 |
| collection_id | 10080 | 10080 |
| name | 21 | 21 |
| cover | https://nfturbo-file.oss-cn-hangzhou.aliyuncs.com/collection/36/image (1).png | https://nfturbo-file.oss-cn-hangzhou.aliyuncs.com/collection/36/image (1).png |
| purchase_price | 212.000000 | 212.000000 |
| serial_no | 7 | 7 |
| nft_id | nftId | nftId |
| pre_id | 29 | 29 |
| user_id | 8 | 8 |
| state | INIT | ACTIVED |
| tx_hash | <font style="color:rgb(153, 153, 153);">NULL</font> | 7e7c28b2-ad82-4431-afca-b9a403f0d389 |
| hold_time | 2025-03-16 13:52:31 | 2025-03-16 13:52:31 |
| sync_chain_time | <font style="color:rgb(153, 153, 153);">NULL</font> | 2025-03-16 13:59:02 |
| delete_time | <font style="color:rgb(153, 153, 153);">NULL</font> | <font style="color:rgb(153, 153, 153);">NULL</font> |
| deleted | 0 | 0 |
| lock_version | 0 | 1 |
| biz_no | 1886333860223307776 | 1886333860223307776 |
| biz_type | TRANSFER | TRANSFER |
| reference_price | 212.000000 | 212.000000 |
| rarity | <font style="color:rgb(153, 153, 153);">NULL</font> | <font style="color:rgb(153, 153, 153);">NULL</font> |


