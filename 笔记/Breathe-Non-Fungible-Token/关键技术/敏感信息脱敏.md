我们的项目中，有一些敏感信息需要脱敏，比如手机号，身份证号，需要在日志，以及页面展示的时候进行脱敏，以免数据泄露。



# 步骤
## 选择脱敏框架
项目选择的是github上的sensitive框架：https://github.com/houbb/sensitive

## maven引入
引入脱敏核心包

```xml
<dependency>
  <groupId>com.github.houbb</groupId>
  <artifactId>sensitive-logback</artifactId>
  <version>1.7.0</version>
</dependency>
```

引入logback包

```xml
<dependency>
  <groupId>ch.qos.logback</groupId>
  <artifactId>logback-classic</artifactId>
  <version>${logback.version}</version>
</dependency>
```

## logback.xml 配置
下面是logback模版

```xml
<configuration>
  <!-- 基于 converter -->
  <conversionRule conversionWord="sensitive" converterClass="com.github.houbb.sensitive.logback.converter.SensitiveLogbackConverter" />
  <!-- 使用 converter -->
  <appender name="STDOUTConverter" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %sensitive%n</pattern>
    </encoder>
  </appender>

  <!-- 使用 layout -->
  <appender name="STDOUTLayout" class="ch.qos.logback.core.ConsoleAppender">
    <layout class="com.github.houbb.sensitive.logback.layout.SensitiveLogbackLayout">
      <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
    </layout>
  </appender>

  <!-- 设置根日志级别为DEBUG，并将日志输出到控制台 -->
  <root level="DEBUG">
    <appender-ref ref="STDOUTConverter"/>
    <appender-ref ref="STDOUTLayout"/>
  </root>
</configuration>
```



这里共计支持 Converter 和 Layout 两种模式，任选一个即可。

建议使用 SensitiveLogbackConverter，脱敏日志内容。



## 脱敏前台展示字段
脱敏注解举例

```java
public class Example {

    @SensitiveStrategyChineseName
    private String username;

    @SensitiveStrategyPassword
    private String password;

    @SensitiveStrategyPassport
    private String passport;

    @SensitiveStrategyIdNo
    private String idNo;

    @SensitiveStrategyCardId
    private String bandCardId;

    @SensitiveStrategyPhone
    private String phone;

    @SensitiveStrategyEmail
    private String email;

    @SensitiveStrategyAddress
    private String address;

    @SensitiveStrategyBirthday
    private String birthday;

    @SensitiveStrategyGps
    private String gps;

    @SensitiveStrategyIp
    private String ip;

    @SensitiveStrategyMaskAll
    private String maskAll;

    @SensitiveStrategyMaskHalf
    private String maskHalf;

    @SensitiveStrategyMaskRange
    private String maskRange;
}
```

增加一个拦截器

当运行getUserInfo的时候

```java
@GetMapping("/getUserInfo")
    public Result<UserInfo> getUserInfo() {
        String userId = (String) StpUtil.getLoginId();
        UserQueryRequest request = new UserQueryRequest();
        request.setUserId(Long.valueOf(userId));
        User user = userService.findById(Long.valueOf(userId));

        if (user == null) {
            throw new UserException(USER_NOT_EXIST);
        }
       
        return Result.success(UserConvertor.INSTANCE.mapToVo(user));
    }
```

对result类型的结果进行一个拦截。

```java
@ControllerAdvice
public class SensitiveResponseBodyAdvice implements ResponseBodyAdvice<Object> {

    @Override
    public boolean supports(MethodParameter returnType, Class<? extends HttpMessageConverter<?>> converterType) {
        // 只对特定类型的返回值执行处理逻辑，这里可以根据需要调整判断条件
        return Result.class.isAssignableFrom(returnType.getParameterType());
    }

    @Override
    public Object beforeBodyWrite(Object body, MethodParameter returnType, MediaType selectedContentType, Class<? extends HttpMessageConverter<?>> selectedConverterType, ServerHttpRequest request, ServerHttpResponse response) {
        // 如果返回的对象是UserInfo，进行脱敏处理
        switch (((Result<?>) body).getData()) {
        case UserInfo userInfo:
			((Result<UserInfo>) body).setData(SensitiveUtil.desCopy(userInfo));
                    
        default:
             return body;
            }

        return body;
    }
```

然后判断返回对象是UserInfo，通过 SensitiveUtil.desCopy(UserInfo)进行脱敏

## 个性化配置
用户可以在应用 resources 下通过 chars-scan-config.properties 配置文件指定。

默认配置

SensitivePatternLayout 配置默认为：

```properties
chars.scan.prefix=:：,，'"‘“=| +()（）
chars.scan.scanList=1,2,3,4,9
chars.scan.replaceList=1,2,3,4,9
chars.scan.defaultReplace=12
chars.scan.replaceHash=md5
chars.scan.whiteList=""
```

