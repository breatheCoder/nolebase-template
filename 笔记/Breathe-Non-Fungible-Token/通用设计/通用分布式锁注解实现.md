我们经常要在代码中使用分布式锁，有很多锁，都是要在方法开始时加锁，结束后解锁的，于是为了方便，我们定义了一个通用的注解，来进行分布式锁的实现。



![[9a05dcea-8027-4f06-b8c7-4761eabf2ce4.png]]



其中定义了很多参数，key和keyExpression二选一，只能有一个，key表示规定值当作锁的key，keyExpression表示是一个Spel表达式 。



使用方法如下：

```java
@DistributeLock(keyExpression = "#payCreateRequest.bizNo", scene = "GENERATE_PAY_URL")
public PayCreateResponse generatePayUrl(PayCreateRequest payCreateRequest) {

}
```



在生成支付链接时，直接在方法上加注解，实现自动加锁和自动解锁。



锁的实现逻辑如下：

![[c505e194-7c2a-4fe6-bf44-34a04896d504.png]]



里面有一个小优化，就是@Order，有个地方用了这个分布式锁，但是幂等还是被击穿了，就是因为没有限制顺序，导致有的代码我们加了@Transactional注解，然后分布式锁直接失效，就是因为这个切面的处理顺序没有设置好。这让我不禁想到看到很多优秀的代码，考虑到了我很多根本考虑不到的点，我认为这些可能和他们心思缜密有关系，但是还有很多原因是因为测试中暴露出来才进行修改的。



通过这个我认为完成一定比完美更重要，不要一遍追求完美，就像写算法一样，先不要追求一遍优化到极致，而是一步一步优化，一步一步思考，这样最终才能更强，如果一味追求完美，最终连完成都没有做到的话，反而显得非常的不值得了。





