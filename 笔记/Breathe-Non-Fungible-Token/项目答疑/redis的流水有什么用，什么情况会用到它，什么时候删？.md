
[[基于Lua+Redis实现库存的秒杀扣减]]


库存扣减的lua 脚本中，我们不仅做了库存的扣减，还用 hash 结构存储了一条流水，流水中记录了以下信息：



```java
key:29_cba99dfd-2bc7-4787-8992-263fbcbe3e7d_1

value：	
{"change":"1","action":"decrease","from":"21","timestamp":1718017957347,"by":"\"29_cba99dfd-2bc7-4787-8992-263fbcbe3e7d_1\"","to":20}
```



![[d106b2a0-e64c-4f41-a28a-6ef2ea433cac.png]]



这里的key是用买家ID，下单的token，以及扣减数量拼接在一起的，value中明确记录了本次扣减变化的库存数，变化前的库存数以及变化后的库存数，还有变化的操作ID，以及变化的时间戳。



这样的一条流水有两个作用

1. 幂等

当我们在lua脚本执行的时候，会先去查询一下是否存在对应的流水，如果查询到了，则说明本次是一个重复请求，直接幂等掉。

2. 对账

redis的库存扣减之后，数据库还是要扣减的，那么如何保证双方都一定成功呢，如何发现不一致的情况呢，这就需要流水了，每一次扣减都有一条流水记录，这样就可以用redis中的流水和mysql中的流水做核对，如果一致的话就没有问题，但是不一致的话，可能是丢消息了，或者系统执行异常了，这时候就需要人工来介入解决这个问题了。



库存流水也不是一直都存在的，以下几种情况会删除，一种是主动删除，一种是惰性删除。



主动删除：

当某条流水完成对账以后，主动删除。

惰性删除：

当商品下架以后，流水设置24小时后到期，到期后基于redis的删除策略删除。

