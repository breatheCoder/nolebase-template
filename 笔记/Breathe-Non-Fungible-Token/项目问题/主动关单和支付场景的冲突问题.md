## 背景
 我现在有一个支付场景，创建订单以后，会有一个定时任务，定期扫描订单表来将超时的订单状态变为cancel，当我的订单进入支付状态后，订单超时变为cancel状态怎么办  



这个可以使用条件判断来进行订单状态的更新

因为他们的来源都来自于confirm



所以可以写如下的SQL语句



```sql
UPDATE orders
SET status = 'CANCEL'
WHERE id = ? AND status = 'CONFIRM' AND now() > expire_time;
```

```sql
UPDATE orders
SET status = 'PAID'
WHERE id = ? AND status = 'CONFIRM';
```



这样子就可以通过订单是否更新来做一个回滚，

比如在支付结束后，应该从confirm -> paid，但是更新行数为0，更新失败，此时就可以进行退款的运动。



最好用这种方案，除了这中方案，还可以用分布式锁。

