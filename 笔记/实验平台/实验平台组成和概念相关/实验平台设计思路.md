## 复用之前的工程

在现在的这个Arena之前，还有一个Horizon，现在相当于是基于之前H工程的一次大升级，为了提高开发效率，我们也采用了不少之前工程的思考去完成新项目的构建，而且现在很多服务都依赖于之前的工程，所以也是必须要做到兼容吧，到时候升级完成以后再来迁移。

## 保证实验结果准确性

### 引入样本量预估机制

因为样本量越大，肯定实验结果就越准确，但是如果太大的话，不仅浪费性能，还会造成样本量的浪费。所以需要科学的确定样本量级。（这里可能就要用到前面提到过的置信区间和置信水平）

### 提供不同实验阶段的样本数据

可以对比不同阶段的样本数据，这样就可以防止由于某个流程的特殊性，而导致的错误判断，我们完全可以在每个阶段让实验组做及时的对照。

### 分流算法的选择

#### 随机分流

Horizon将每个实验层分成了1000个桶，每个实验桶分为100个策略桶。流量分流过程中至少需要三次hash运算。
**第一次hash运算**
发生在进入实验层时，通过业务信息和用户唯一标识计算得到实验桶的编号，根据数据库中的配置判断这个桶在隔离区还是实验区。若命中隔离区，仅返回该层转全策略，若命中实验区，就要判断有没有相关实验，比如父子实验等等，必须要下组接着实验，那么就不需要进行hash，直接进行实验，如果没有的话，我们就可以进行hash，让他来随机分配，不需要维护实验的连续性，这里第一次hash用的是业务信息和用户的唯一标识来处理的。
**第二次hash运算**
发生在流量进入实验桶前，为了保证层之间的正交性，需要将**层唯一标识**作为哈希因子加入计算，得到重新分配后的实验桶的编号，
**第三次hash运算**
发生在流量进入实验桶后，通过业务信息，离散因子（用于实验打散），实验唯一标识，用户唯一标识计算出策略桶的编号，从中取出对应的策略，与该层中的转全策略合并后返回。
#### 时间片分流
这个原理是一样的，只是在随机的时候，我们是用用户的唯一标识来分流，时间片我们是通过时间，比如下一秒打进去的用户请求都来这个桶中，不关心每个用户都选择，而是一个时间内用户的选择，这就导致了，同一个用户可以进入不同的组中。
这种使用条件，一般是用户感知小的，要不然前后用户体验差距过大也不好，会影响用户体验。

## 系统设计

全流程
![[Pasted image 20250925193456.png]]

实验假设 -> 预估收益 -> 设计实验 -> 配置实验 -> 实验上线 -> 分析效果 -> 实验结果

系统架构图
![[Pasted image 20250925193658.png]]

整体上分为离线和在线两个模块
### 在线
先是业务层，将用户的数据进行一些业务处理，然后通过接入层，这是我们下面的系统层和数据的接口，先通过业务层处理数据，然后将数据发给接入层接入数据，再在系统层中进行实验，配置，运维管理。

### 离线
离线和在线最大的不同就是：离线的数据是从数据仓库来的，而在线数据是用户主动生成的，因为离线我们的生成速率是可控的，所以并没有做容灾备份，熔断降级，紧急干预等操作

### 整体架构UML

![[Pasted image 20250925194706.png]]

#### 实验接入架构设计
其实是没太看懂第一张原始架构图，新方案我也没太看懂，这个整个链路看下来，他是咱们内部配置了实验以后，然后一步一步推送到上游和更新下游数据。但这不是实验接入吗？嗷嗷嗷，他说的接入是实验的接入，而不是用户端的接入

那先用文字描述一遍原架构的设计，管理员先配置实验到管理端，管理端将变更推送到lion，并且更新分布式缓存的信息，分布式缓存将服务端的信息通过请求变更，管理段还会去同步数据库中的信息，到服务端以后，就会通过MQ将日志上报，然后将用户入口的请求分流。关于lion，他在配置更新以后，他会通知下游去做更新。
![[Pasted image 20250925201642.png]]

#### 用户请求实验架构设计
![[Pasted image 20250925201748.png]]

#### 实验变更技术方案
![[Pasted image 20250925202630.png]]
#### Arena实验平台架构图

![[Pasted image 20250925203001.png]]

如何结合arena进行实验
![[Pasted image 20250925203044.png]]