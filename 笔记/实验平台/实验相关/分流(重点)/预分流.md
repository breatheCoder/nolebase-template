# 预分流适用场景
为了避免AA实验无法通过的情况，降低AA实验不通过的概率，我们引入了预分流功能。

什么是AA，为什么不通过，我们怎么让他通过呢？这是我们重点关注的点

> 其实很简单，我们都知道我们实验平台是通过AB实验来比较不同方案在相同场景下对于性能的提升或者方案的好坏。
> 
> 但是如果没有对于测试数据进行一些比较，我们就可能出现实验结果出现较大的偏差，所以我们在做AB实验之前会进行AA实验，也就是让对照组和实验组在相同条件下，相同的策略，看看他们的结果相同吗
> 
> 举一个例子：
> 我们想要验证按钮从**蓝色**改为**红色**能不能提升**点击率**，在真正做对照之前，我们需要在**对照组和实验组都先设置为蓝色**，对比他们的点击率是否在可接受的误差范围内，比如通过**P值比较**，**点击率比较**，如果发现这两个组别中点击率差不多，我们就认为在这个实验中，他们的数据来源是相同的，就可以利用这些数据进行AB测试实验。在测试之后发现**红色按钮的点击率有明显提升**，就认为**红色可以提升点击率。**

由于不同组的流量我们也不能控制用户的活跃度，有可能有些组用户的活跃度天生就高，

那么我们如何避免这种问题呢？
有两种方案

1. **利用大规模的流量去进行测试**，流量越大肯定越准确，也就是你投掷骰子的频率越高，最终会每个点数的频率会趋近于概率
2. **预分流**：这种方案也就是我们所要重点介绍的方案了。先在这里简单介绍一下，假如我们要在美团首页的金刚区做变更，提高金刚区的点击率，预分流就会在Arena先创建一个实验（这个实验是离线实验）并开启预分流，他会将过去7天内所有曝光在美团首页中的用户模拟拆分为实验组，对照组，并验证每组用户在过去7天的金刚区点击率是否有明显差异，如果无明显差异，用户可正常上线实验AA，AB，反之则认为分流不均匀，系统重新模拟分组并验证，直至预分流通过或者超过重试次数3。

PS：**预分流只能提升AA实验的通过率，他不能保证AA实验一定通过**（如果能保证都不需要AA实验了）

## 为什么无法保证AA实验100%通过？
因为咱们模拟的只是过去七天的用户数据，他永远没有办法代表当下的数据，可能突然中彩票了，人家交易变多了，或者疫情破产，交易变少，都是有可能的，他只能对于流量的分布做一个预测，如果大概率通过不了，我们就不需要再进行AA实验了。

# 如何使用预分流
## 确定当前实验的真实分流时机
作为实验的发起方，需要确定什么时候用户会命中你的实验
- 如果你的实验是**客户端实验且自动上报**，那么用户一打开美团APP就可以命中你的实验，一打开就可以对用户进行分流。
- 如果你的实验是**客户端实验且手动上报**，需要创建该实验的同学自定义分流时机。
## 确定是否有和当前实验分流时机匹配的预分流时机
这里的预分流其实我们可以把它看成一段SQL，可以取到过去有**某种行为**的一组**用户ID的集合**（这个行为就是能命中实验的行为），预分流就是这样，
1. 先通过SQL取到用户
2. 然后再将其模拟分为对照组和实验组
3. 再通过 [[分流均匀性校验SOP]] 来验证不同组别差异
4. 会通过 [[分流均衡性优化--分流因子择优]] 来更好的选择分流因子
如果分析差异显著，就不能通过预分流。如果差异不显著，就可以通过预分流，后续基于该分组上线或者打散流量。

时机：
默认时机
1. 首页曝光分流（**一进入主页就分流**）
2. 搜索api调用分流（**用户触发某种行为之后会调用搜索API接口进行分流**，命中实验）
各业务自建的预分流的时机
其实主要就是对不同的方法进行埋点，然后再编写对应的SQL语句可以获取到对应的用户就可以了。
## 创建/编辑实验的时候开启预分流
目前平台支持在上线实验和打散实验进行预分流

在平台上配置不同的配置就可以了，预分流的实验结果可以通过大象发送，之后线上的数据分流也是按照这个来处理。

## 如果已经进行实验前AA，发现AA未通过，能否利用预分流功能进行配平

可以的，待后续更新

# 流程和代码实现
![[Pasted image 20251013162507.png]]
用语言描述一下整个预分流实验的大体流程吧

因为我们的预分流实验也是在某个点对用户的流量进行分流的。
所以第一步肯定是
**创建预分流时机**
之后的实验都是在这个时机进行的。
时机确定以后，我们可以用内两个默认时机，也可以自定义时机，但是这个得联系平台管理员来添加。
创建完毕时机，我们就可以进行下一步
**创建预分流实验**
这就是这次预分流做了什么事情创建出来，其实和AA实验的实验我认为没有什么太大的区别，然后进行下一步
**选择支持预分流的数据集**
这是我认为预分流和实验前AA一个最大的不同，也就是来源不同，预分流的实验数据来自于前一周或两周的数据，但是，实验前AA是用户的实时流量，这也是为什么预分流不能代替实验前AA的原因，他只是对AA实验的结果做一个有效的预测。
以上两步在执行的时候会同步更新到数据库中
**任务调度**
这时候我们可以通过我们的**分布式任务调度平台Crane来处理任务**，比如模拟分流任务，指标计算任务和失败任务的重试，**spark**那边，会将他们要处理的类似的任务发送给**dataOpenPlatform**来处理，
任务处理完毕以后，我们要将结果上报给mysql
**分流数据存储**
直接存储在数据库中
**查看预分流报告**
没什么说的，将数据库的信息返回出去
**最终决策**
但是最终还是实验人员来判断这里到底可不可以通过。
## 创建预分流实验的步骤
![[Pasted image 20251013162835.png]]
# 模块
## 预分流时机模块
### 预分流时机服务类 SeedMomentService
**保存预分流时机saveSeedMoment()方法**
这里面的目的很简单，就是将在哪里预分流的时机保存到数据库中，但是因为我们之后的操作都要根据这里的数据进行操作，所以这里的操作坚决不能出错，所以做了两层校验：**校验保存字段**和**预分流时机SQL是否匹配**（这里的时机指的是开始时间和结束时间）
执行顺序:
checkField() --> parseSql() --> arenaDataSourceEngineService.getSqlOverviewResponse(seedMomentSql)
主要来说说链路的后两部分：
#### parseSql()
这个主要就是校验SQL中有没有开始和结束日期，如果没有的话就不好了，后续的很多都要根据这两个参数来进行操作，所以要先校验存不存在，如果不存在直接返回，存在的话再来saveSql。
![[Pasted image 20251015100853.png]]
就是这里，会对这两个参数做一个校验
#### getSqlOverviewResponse(seedMomentSql)
这个方法就是一些对于语法的一些校验，最后将sql的解析结果返回。
调用的是sinux，一个sql解析器。
返回之后，和用户在saveSeedMoment设置的参数做一个比较，如果一致的话，校验通过。

到此，预分流时机模块就分析完毕，整体逻辑其实就是将用户的参数和SQL语句做了重点的校验，并将校验通过的结果存储到数据库中。
## 预分流实验模块
### 实验编辑
#### 实验平台ArenaExperimentController
![[Pasted image 20251015105736.png]]
核心逻辑是先通过listIndicatorFilterByIdType()方法去获取到实验相关数据，但是把所有的数据都查出来了，我们这个方法的核心操作就是对数据分类。
![[Pasted image 20251015110316.png]]
这个是核心操作，就是将不同组的指标数据，利用groupId进行分组，然后放到groupVoS中
### 实验报告
#### PriorAaTaskService类中的searchTaskDetail()方法
这个接口其实就是查看预分流任务详情的接口
![[Pasted image 20251015111338.png]]
这里是对于在各个表中查询出信息，然后对于信息的一个整合。

#### 查询预分流报表 DataEngineReportService类的concurrentQuery()
![[Pasted image 20251015140452.png]]
核心逻辑就是这个，构建好需要查询的所有数据，然后通过future将这些任务进行批处理，返回，如果异步任务全部出错的话，返回异常 **"请联系管理员"**

这里的复杂逻辑主要就是查询的过程。
##### query()
![[Pasted image 20251015143022.png]]
这就是query的逻辑，看看我们是如何查询出结果的：
首先我们会判断是否有下钻参数（这个下钻相当于是一个粒度细化的参数）
举个例子吧：我们现在一年能赚1000w，但是赚钱来源很多，有炒股，炒币，工资，如果我们只分析炒股的赚的钱，那么就是一维下钻，如果我们分析炒股和炒币，那么就是二维下钻，以此类推......

反正根据请求获取完数据以后，我们就获得了可以展示的所有数据，然后设置该报告的展示形式，设置完毕以后，调用queryData来返回，这个queryData的主要作用就是其中有一个APL类，他主要生成一些可以让前端展示的数据。比如图标，表格等等，queryData也会在其中计算一些关于P值，Z值，一些实验相关数据的计算。
![[Pasted image 20251015144742.png]]
这就是其中的一个参数统计，其中还有比如DIFF，显著性等一些其他参数的计算。
##### 选择分流因子并上线：PriorAaTaskService类的chooseFactor()方法
![[Pasted image 20251015145500.png]]
这个就是预分流上线逻辑，先看看预分流任务存在吗，如果存在的话，不存在的话就throw exception，再一次判断实验信息和实验打散信息和打算时间，重点是打散，其实没太看懂，为什么第一次来到这个方法的时候要标记为废弃，难道这个方法不是正常调用吗？下面就是方法的重试，更新一下相关信息。
## 预分流任务管理模块
![[Pasted image 20251015144627.png]]
- [ ] 预分流任务管理模块