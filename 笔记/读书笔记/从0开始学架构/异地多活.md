# 概述
简单来说和集群模式的目的是一样的，**防止部分服务宕机的场景下，服务不可用**，那么他和集群的区别是什么呢？集群不也可以解决这种问题吗？虽然他们解决的表面上是同一个问题，但本质他们的场景是不同的，如果是简单的集群，他处理的问题主要是其中几台机器由于某些不可控的异常导致的宕机，比如硬盘损坏之类，他不是内种大规模的停电，不可能导致整个集群全部宕机，这个时候用简单的集群就可以解决问题，但是如果发生了大规模的自然灾害，比如洪水，地震等，使得一块地区的整个机房全部损坏，那么这个集群肯定消失了，我们也没办法解决问题，即使是备份，由于其中的数据不常在线上运行，可能会导致其他难以处理的问题，而且即使要将这些数据上线，可能也要经过几分钟甚至半天，这是我们无法接受的，会严重影响用户的使用体验，这种情况我们就可以使用异地多活。
# 什么是异地多活
我们可以把它看成两个部分 **异地** 和 **多活**
他要满足这两个条件
### 异地
两个节点要部署在两个不同的**地方**，在不同的场景下这个地点的远近也有不同的要求，我们可以在下面做详细介绍。
### 多活
活 -> 活跃，所以意思就是用户在访问A节点可以获取到正确的响应，访问B节点也可以获取到正确的响应，在我眼里，他们就是一个**两个节点距离很远的**cluster。
# 不同场景对于异地距离的把控
我们都知道数据是通过光纤传输的，我们的数据传输需要时间，距离越远，传输越慢，而且中间的光纤的情况我们都是未知的，有可能被挖掘机挖断，有可能地震震断，再结合不同的数据对于数据的要求，可能有些敏感数据，如果异地太远的话，就会造成数据不一致给公司带来大量的损失。

根据地理位置划分，异地多活架构可以分为：
1. 同城异区
2. 跨城异地
3. 跨国异地
### 同城异区
这种架构指的是**将机器节点部署在同一个城市的不同区**，比如太原的万宝林区和小店区，然后将两个机房用专用的高速网络连接起来。
如果我们考虑一些极端的场景，假如太原发生了8级大地震，肯定是没用的，那么我们为什么还要设计同城异区这种架构呢？其实答案就在于**同城**。

同城异区的两个机房，距离一般就是几十千米，通过高速传输网络，完全可以逼近同一个机房的传输速度，所以**逻辑上我们可以将他们看成同一个机房**，降低了复杂度和实现成本。

如果采用这种架构，遇到八级大地震，这是真没招了，但是这种特别大的灾难，其实不知道多少年才发生一次，和这个比较，机房火灾，机房停电，机房空调故障这种事故发生的概率会更大，而这些故障场景，同城异区架构都可以很好的解决。因此综合考虑，**同城异区是应对机房级别故障的最优架构。**
### 跨城异地
这种架构指的是**将机器节点部署在不同城市的多个机房，并且距离尽可能远一点**，这样才能有效的避免内种大规模的灾难，不能说将他们离得太近，很好理解，害怕波及到周围城市，没有起到跨城异地的作用。

虽然跨城异地可以有效的防止灾难，但是由于距离的限制已经由量变引起质变，我们**无法再将他们看成同一个机房内的节点**。
这就会导致一个看似矛盾的地方：**数据不一致业务肯定不会正常，但跨城异地肯定会导致数据不一致**，如何解决这个问题呢？其实我们本质来说并没有解决，而是**不同的场景选择不同的方案**，我们可以通过数据的一致性程度选择不同的方案

举个例子吧，一般金额类的数据是没有办法做跨城异地多活的，假设我们做一个互联网金融业务，用户余额支持跨城异地多活，我们的节点分别部署在北京和广州，会出现以下场景：
- 用户A有10000块，北京和广州都是这个数据
- 用户A向用户B转了5000块，修改的是广州节点的数据，广州还剩5000块
- 由于挖掘机将光纤挖断了，广州的变动无法通知北京，北京现在还是10000块
- 此时用户A发现自己还是10000块，就向用户C转账10000块，转账完成后北京还剩0块
- 用户A刷新了一下发现自己还有5000块，赶紧又转账给D，这时候钱才算花完了
这时候我们可以看到，虽然他只有10000，但是他花了20000啊。所以对于余额这种和金钱相关性特别强的，一般不会使用跨城异地，而是采用同城异区，而对于那些**一致性要求不高的，数据不怎么改变或者即使丢失也不影响业务的数据，我们就可以去做跨城异地**。
比如用户登录，评论，新闻类网站，其实都很适合跨城异地架构
### 跨国异地
跨国异地指的是业务部署在不同国家的多个机房。相比跨城异地，跨国异地的距离就更远了，因此数据同步的延时会更长，正常情况下可能就有几秒钟了。
这时候我们就无法得到满足**多活**的条件了：**正常情况下，用户无论访问哪个节点，都会得到正确的响应**。

这种时候我们就采用不同的策略了，比如每个国家的数据不一样，比如中国的亚马逊账号没有办法登录美国的亚马逊，这样天然就可以避免这种问题。